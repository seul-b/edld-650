---
title: "DARE-1"
author: "Seulbi Lee"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
library(dplyr)
library(Hmisc)
library(readr)
library(ggplot2)
dat <- read_csv("EDLD_650_DARE_1.csv")
```

```{r data management tasks}
# A1
enroll_conv <- grep("^enroll_", names(dat), value = TRUE)
for (col in enroll_conv) {
  dat[[paste0(col, "_pct")]] <- (dat[[col]] / dat$enroll) * 100
}


# A2
dat <- dat |> 
  mutate(eval = ifelse(school_year >= eval_year, 1, 0),
         class_remove = ifelse(school_year >= class_remove_year, 1, 0),
         suspension = ifelse(school_year >= suspension_year, 1, 0),
         run_time = school_year - eval_year,
         run_time = ifelse(is.na(eval_year), -1, run_time),
         across(eval:suspension, ~ifelse(is.na(.x),0, .x)),
         evalXyear = eval * run_time)


```

```{r understanding the data and descriptive statistics}
# B1
summary(dat) # check missingness 

# PBIS concerning, nothing else 
# not too much worried as we don't use the variable 

dat_complete <- dat[!is.na(dat$ODR_class) & !is.na(dat$ODR_objective) & 
                    !is.na(dat$ODR_other) & !is.na(dat$ODR_subjective), ]

# B2
viz_class <- ggplot(dat_complete, aes(ODR_class)) + geom_histogram(binwidth=1)
viz_class
viz_objective <- ggplot(dat_complete, aes(ODR_objective)) + geom_histogram(binwidth=1)
viz_objective
viz_other <- ggplot(dat_complete, aes(ODR_other)) + geom_histogram(binwidth=1)
viz_other
viz_cobjective <- ggplot(dat_complete, aes(ODR_objective)) + geom_histogram(binwidth=1)
viz_cobjective

# uni-modal, skewed
# log transformation or box-cox transformation <- just mention it 

# B3
library(dplyr)

# sample -- refer to the paper

calculate_weighted_stats <- function(data, variable) {

  # Group by school_year and calculate total enrollment for each year
  data <- data |> 
    group_by(school_year) |> 
    mutate(year_total_enrollment = sum(enroll, na.rm = T)) |> 
    ungroup()

  # Calculate the weighted variable
  data$weighted_var <- (data[[variable]] * data$enroll) / data$year_total_enrollment
  
  # Calculate mean and standard deviation for the weighted variable
  mean_weighted_var <- mean(data$weighted_var, na.rm = T)
  sd_weighted_var <- sd(data$weighted_var, na.rm = T)

  # Return a list with the results
  return(list(mean = mean_weighted_var, sd = sd_weighted_var))
}

# no need mean state-year enrollment/ mean year enrollment

frpl_stats <- calculate_weighted_stats(dat_complete, "FRPL_percent")
am_indian_stats <- calculate_weighted_stats(dat_complete, "enroll_AM_pct")
asian_pi_stats <- calculate_weighted_stats(dat_complete, "enroll_ASIAN_pct")
black_stats <- calculate_weighted_stats(dat_complete, "enroll_BLACK_pct")
hispanic_stats <- calculate_weighted_stats(dat_complete, "enroll_HISP_pct")
white_stats <- calculate_weighted_stats(dat_complete, "enroll_WHITE_pct")
pbis_stats <- calculate_weighted_stats(dat_complete, "PBIS")
odr_class_stats <- calculate_weighted_stats(dat_complete, "ODR_class")
odr_other_stats <- calculate_weighted_stats(dat_complete, "ODR_other")
odr_subjective_stats <- calculate_weighted_stats(dat_complete, "ODR_subjective")
odr_objective_stats <- calculate_weighted_stats(dat_complete, "ODR_objective")

```

```{r replication and extension}
# C1
library(fixest)
model1 <- feols(ODR_class ~ eval | state_id + school_year, data = dat_complete)

model2 <- feols(ODR_class ~ eval*run_time | state_id + school_year, data = dat_complete)

model3 <- feols(ODR_class ~ eval + run_time + evalXyear | state_id + school_year, data = dat_complete)

# not significantly different from 0 
# Keep models 2+3
# commented out vcov = ~ state_id^school_year as it was said "cells report estimates and associated standard errors clustered at the state level in parentheses." pg 21

# Creating a dataframe to hold the table data
table_data <- data.frame(
  Variable = c("Implement evaluation", "", "Implement evaluation*Trend", "", 
               "Time Trend", "", "Observations", "R-Squared"),
  Class_I = c("-0.061", "(0.168)", "", "", "", "", "470", "0.566"),
  Class_II = c("-0.064", "(0.172)", "-0.064", "(0.164)", "0.018", "(0.063)", "470", "0.565")
)

# Writing the Markdown table
writeLines(knitr::kable(table_data, format = "markdown", align = c('l', 'r', 'r')))


# C2


```