---
title: "DARE-2"
author: "Seulbi Lee, Havi Khurana, Janette Avelar"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(pacman)
p_load(here, tidyverse, DT, ggplot2, xaringan, knitr, kableExtra, modelsummary, stargazer, xaringanthemer, gganimate, ggthemes, fixest, haven)
dat <- read_dta(here("DARE-2", "EDLD_650_CA_schools_es.dta"))
```

### A. Assumption tests

**A1.** The following figure (Figure 1) shows the effect of the Academic Performance Index (API) of an individual school in 2003 on textbook funding allocation through Williams settlement funding in 2005. In the graph, the vertical dotted line represents the cutoff score for eligibility, as determined at each school level. As expected, there is a sharp change at the cutoff, with schools below the API cutoff receiving textbook funding in 2005.

**Figure 1**
```{r }
dat %>% 
  ggplot() +
  geom_jitter(aes(api_rank, receive_williams), 
              color = "gray", alpha = 0.4, shape = 16) + 
  geom_line(aes(api_rank, ind), 
            color = "red", linetype = "dashed", size = 1.5) +
  theme_pander(base_size = 15) + 
  labs(x = "API rank in 2003",
       y = "Williams recipient in 2005")
```

**A2.** In Figure 2, we examine potential bunching around the forcing variable to determine whether schools just above the cutoff point may have attempted to receive an API score that would have made them eligible to receive additional funding. Here, we have limited our sample using Holden's bandwidth of 19.099, observing a total of 1,947 schools. The distribution of schools is smooth through the cutoff. Coupled with the decision to use API scores from the year prior to announcing and implementing funding, we argue that there is enough evidence against the possibility of nonrandom sorting.

**Figure 2**
```{r }
#first examine bunching
dat %>% 
  mutate(subset = case_when(
    api_rank >= 643 - 19.099 ~ 1, #Holden's bandwidth
    api_rank <= 643 + 19.099 ~ 1,
    TRUE ~ 0
  )) %>% 
  filter(subset == 1) %>% 
  ggplot() +
  geom_histogram(aes(api_rank), 
                 fill = "cornflowerblue", 
                 binwidth = 1)  +
  geom_vline(xintercept = 643, 
             color = "red", 
             linewidth = .5) +       
  theme_pander(base_size = 15) + 
  labs(x = "API rank in 2003 relative to Williams' cutoff")
```

### B. Replication and Extension

**B1.** An initial visual inspection of our data indicates that the receipt of additional funds for textbooks improved test score outcomes for elementary students in California. For the following graph (Figure 4), we retained Holden's bandwidth of +/- 19.099. Using this bandwidth, we observed a positive linear trend associated with the additional funding.

**Figure 4**
```{r }
dat %>% 
  filter(api_rank >= 623.901 & api_rank <= 662.099) %>% 
  mutate(ind = factor(ind)) %>% 
  group_by(api_rank) %>% 
  summarise(across(c("average_score", "ind"), mean)) %>% 
  mutate(condition = ifelse(api_rank <= 643, "Received funding", "Did not receive funding")) %>% 
  ggplot(aes(api_rank, average_score, color = condition)) +
  geom_point(alpha = 0.8, shape = 16) +
  geom_smooth(method = "lm", 
              formula = y ~ poly(x, 2),
              se = FALSE) +
  geom_vline(xintercept = 643, 
             color = "red", 
             linewidth = .5) +
  theme_pander(base_size = 15) +
  theme(legend.position="none") +
  labs(x = "API",
       y = "Average math/reading score",
       color = "Condition")
```

**B2.** 

**Table 1**
```{r }
#2005 Model
dat05 <- dat %>%
    filter(year == "2005") %>%
    filter(norm > -19.099 & norm < 19.099) %>% 
    mutate(treatment = ifelse(norm > 0, 0, 1),
           treatment = factor(treatment, levels = c(0,1)))

mod05 <- feols(average_score ~ treatment*norm + yrs_teach + yrs_dist + pct_ai + pct_as + pct_pi + pct_fi + pct_hi + pct_aa + pct_wh + total + percentfrl, 
               data = dat05,
               cluster = dat05$distid)
#2006 Model
dat06 <- dat %>%
    filter(year == "2006") %>%
    filter(norm > -19.099 & norm < 19.099) %>% 
    mutate(treatment = ifelse(norm > 0, 0, 1),
           treatment = factor(treatment, levels = c(0,1)))
mod06 <- feols(average_score ~ treatment*norm + yrs_teach + yrs_dist + pct_ai + pct_as + pct_pi + pct_fi + pct_hi + pct_aa + pct_wh + total + percentfrl, 
                 data = dat06,
               cluster = dat06$distid)
#2007 Model
dat07 <- dat %>%
    filter(year == "2007") %>%
    filter(norm > -19.099 & norm < 19.099) %>% 
    mutate(treatment = ifelse(norm > 0, 0, 1),
           treatment = factor(treatment, levels = c(0,1)))
mod07 <- feols(average_score ~ treatment*norm + yrs_teach + yrs_dist + pct_ai + pct_as + pct_pi + pct_fi + pct_hi + pct_aa + pct_wh + total + percentfrl, 
                 data = dat07,
               cluster = dat07$distid)
#2008 Model
dat08 <- dat %>%
    filter(year == "2008") %>%
    filter(norm > -19.099 & norm < 19.099) %>% 
    mutate(treatment = ifelse(norm > 0, 0, 1),
           treatment = factor(treatment, levels = c(0,1)))
mod08 <- feols(average_score ~ treatment*norm + yrs_teach + yrs_dist + pct_ai + pct_as + pct_pi + pct_fi + pct_hi + pct_aa + pct_wh + total + percentfrl, 
                 data = dat08,
               cluster = dat08$distid)
#2009 Model
dat09 <- dat %>%
    filter(year == "2009") %>%
    filter(norm > -19.099 & norm < 19.099) %>% 
    mutate(treatment = ifelse(norm > 0, 0, 1),
           treatment = factor(treatment, levels = c(0,1)))
mod09 <- feols(average_score ~ treatment*norm + yrs_teach + yrs_dist + pct_ai + pct_as + pct_pi + pct_fi + pct_hi + pct_aa + pct_wh + total + percentfrl, 
                 data = dat09,
               cluster = dat09$distid)

#table
modelsummary(list("2005" = mod05, 
                  "2006" = mod06, 
                  "2007" = mod07, 
                  "2008" = mod08, 
                  "2009" = mod09),
             estimate = "{estimate} [{conf.low},{conf.high}]",
             stars = TRUE,
             coef_map = c("treatment1" = "Received Funding"),
             gof_omit = "AIC|BIC|Log|RMSE|R2 .*",
             title = "Table 1. Effect of Textbook funding on Average Scores",
             notes = "Model estimates and 95% Confidence Intervals are presented. A bandwidth of 19.099 was selected around the threshold. Controls included demographic characteristics of students, teacher experience, and average class size in school.")
```

**B3.**