---
title: "DARE-4"
author: "Seulbi Lee, Havi Khurana, Janette Avelar"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      error = FALSE,
                      warning = FALSE)
```

```{r}
#Load package and read data
library(haven)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(fixest)
library(ggthemes)
library(MatchIt)

# read data
dat <- read_dta("dumont_umansky_ECLSK.dta")
```

```{r A1}
summary(dat)
#
# dat <- dat |> 
#   mutate(
#     race = as.factor(race), 
#     elprgm = as.factor(elprgm), 
#     female = as.factor(female), 
#     rural = as.factor(rural), 
#     hisp = as.factor(hisp)
#   )

summary_table_a1 <- dat |> 
  group_by(elprgm) |> 
  summarise('N' = n(),
            'Language Skills'= round(mean(tlangk) , 3), 'Math Skills' = round(mean(tmathk) , 3)) |> 
    mutate(elprgm = if_else(elprgm == 1, "EL", "Non EL")) |> 
    rename('EL Status' = elprgm)

table_a1 <- kable(summary_table_a1, format = "html", caption = "Table 1. Summary of Teacher Perceptions of Student Skills by English Learner Program Participation", align = c('l', 'r', 'r', 'r')) |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center") |>
  column_spec(1, bold = T)

table_a1
```

#### A1.
The table shows a summary of teacher perceptions of student skills by English Learner (EL) program participation. For non-EL students, the perceived skills in language are at 0.061 and in math at 0.073, indicating slightly above neutral or average perception. For EL students, the perceived skills in language are at -0.392 and in math at -0.292, indicating a below-average perception. It is evident that teachers perceive EL students as having weaker language and mathematics skills compared to non-EL students. The negative values for EL students suggest a perception of below-average abilities, while the positive values for non-EL students suggest a perception of above-average abilities.

However, this evidence should not be interpreted as a plausibly causal estimate of the effect of being classified as an EL student on teachers' perceptions because the data does not control for other variables that might influence teacher perceptions, nor does it establish a before-and-after comparison for the same students. 


```{r A2}
full_sample_summary <- dat |>
  summarise(
    'Family SES (standardized)' = mean(ses, na.rm = TRUE),
    Female = mean(female, na.rm = TRUE) * 100, 
    'Chronically absent in kindergarten' = mean(chrabsk, na.rm = TRUE) * 100,  
    'Rural location' = mean(rural, na.rm = TRUE) * 100, 
    'Executive function' = mean(kexecfunc1, na.rm = TRUE),
    'Preschool Language Assessment Scale' = mean(prelas, na.rm = TRUE),
    'English Basic Reading Skill' = mean(ebrs, na.rm = TRUE),
    'Reading assessment' = mean(kread, na.rm = TRUE),
    'Math assessment' = mean(kmath, na.rm = TRUE)
  ) |>
  mutate(Group = "Full Sample")

el_summary <- dat |>
  group_by(elprgm) |>
  summarise(
    'Family SES (standardized)' = mean(ses, na.rm = TRUE),
    Female = mean(female, na.rm = TRUE) * 100, 
    'Chronically absent in kindergarten' = mean(chrabsk, na.rm = TRUE) * 100,  
    'Rural location' = mean(rural, na.rm = TRUE) * 100,  
    'Executive function' = mean(kexecfunc1, na.rm = TRUE),
    'Preschool Language Assessment Scale' = mean(prelas, na.rm = TRUE),
    'English Basic Reading Skill' = mean(ebrs, na.rm = TRUE),
    'Reading assessment' = mean(kread, na.rm = TRUE),
    'Math assessment' = mean(kmath, na.rm = TRUE)
  ) |>
  mutate(Group = if_else(elprgm == 1, "EL", "Non-EL")) |> 
  ungroup() 

combined_summary <- full_sample_summary |>
  bind_rows(el_summary) |>
  pivot_longer(cols = -Group, names_to = "Measure", values_to = "Value")

combined_summary_wide <- combined_summary |>
  pivot_wider(names_from = Group, values_from = Value)

combined_summary_wide <- combined_summary_wide |>
  slice(-10) |> 
  mutate(across(c(`Full Sample`, `Non-EL`, `EL`), ~ case_when(
    Measure %in% c("Female", "Chronically absent in kindergarten", "Rural location") ~ paste0(sprintf("%.2f", round(., 2)), "%"),
    TRUE ~ sprintf("%.2f", round(., 2))
  )))

table_a2 <- kable(combined_summary_wide, format = "html",
                  caption = "Table 2. Comparisons of Student and School Characteristics and Test Scores Between Full Sample, EL, and Non-EL Students") |>
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = F,
    position = "center"
  ) 

table_a2
```

#### A2. 
This observed heterogeneity across groups underscores the need for a sophisticated matching algorithm in our analytical strategy for Section B. In Section B, we aim to create balanced groups of EL and Non-EL students across these covariates, reducing confounding and improving the robustness of our causal inferences regarding the impact of EL status on academic outcomes. By ensuring comparable groups, CEM allows us to attribute differences in outcomes more confidently to EL status rather than to underlying demographic or socioeconomic factors.

```{r B1}
# 1. Fit logistic selection model estimating probability of home language, given covariates
pscores <- feglm(elprgm ~ prelas + ebrs + ses + rural + female + hisp, family=c("logit"), data=dat)
summary(pscores)

# 2. Estimate fitted probability of selection into treatment for each individual
pscore_df <- data.frame(p_score = predict(pscores, type = "response"),
                        elprgm = dat$elprgm)
head(pscore_df)

# 3. Examine common support
ggplot(pscore_df, aes(p_score, fill = as.factor(elprgm), color = as.factor(elprgm))) + 
  geom_density(alpha=0.1) + 
  theme_pander(base_size = 12) + 
  xlab("Probability of Home Language")
```

#### B1. 

```{r B2}
#### Step 1. Define coarsened bins of covariates within which to match

# Quintiles for prelas
summary(dat$prelas)
prelascuts <- c(14.00, 15.89, 19.00)

# Quintiles for ebrs
summary(dat$ebrs)
ebrscuts <- c(8.00, 11.94, 16.00)

# Quintiles for ses
summary(dat$ses)
sescuts <- c(-1.04, -0.48, -0.08)

dat$prelas_coarsened <- cut(dat$prelas, breaks = c(-Inf, prelascuts, Inf), include.lowest = TRUE)
dat$ebrs_coarsened <- cut(dat$ebrs, breaks = c(-Inf, ebrscuts, Inf), include.lowest = TRUE)
dat$ses_coarsened <- cut(dat$ses, breaks = c(-Inf, sescuts, Inf), include.lowest = TRUE)

#### Step 2. Define matching bins 
cem <- matchit(elprgm ~ prelas_coarsened + ebrs_coarsened + ses_coarsened + rural + female + hisp, 
               method = "cem", 
               data = dat)

df_cem <- match.data(cem)

# Have we dropped any? Yes
All <- table(dat$elprgm)
Matched <- table(df_cem$elprgm)
Unmatched <- All - Matched

All_df <- as.data.frame(All)
Matched_df <- as.data.frame(Matched)
Unmatched_df <- as.data.frame(Unmatched)

names(All_df)[2] <- "Original"
names(Matched_df)[2] <- "Matched"
names(Unmatched_df)[2] <- "Unmatched"

Table <- merge(All_df, Matched_df, by = "Var1")
Table <- merge(Table, Unmatched_df, by = "Var1")
names(Table)[1] <- "EL Status"

Table
```

#### B2. 
The identification strategy leverages natural variations in EL classification criteria across locales, creating a quasi-experimental design to assess how EL status influences teacher perceptions. The strategy assumes that these variations effectively randomize EL classification among students with similar English proficiency, allowing for a comparison that isolates the effect of EL status. The matching procedure used, coarsened exact matching, controls for English proficiency and other covariates, resulting in a refined sample where the only systematic difference between groups is EL status. This process excluded 124 non-EL and 179 EL students from the original sample, indicating that the matched sample more accurately represents comparable students across EL classifications.


```{r B3}

```

#### B3.

```{r B4}

```

#### B4.

```{r B5}

```

#### B5.


#### B6.
